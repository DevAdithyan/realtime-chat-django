{% extends 'base.html' %}
{% block content %}

<div class="chat-wrapper">

    <!-- Back button -->
    <div class="chat-back-bar">
        <button class="btn-back" onclick="window.location.href='{% url 'user_list' %}'">
            ← Back
        </button>
    </div>

    <!-- Chat header -->
    <div class="chat-header-bar">
        <div class="chat-header-avatar">
            {{ other_user.username|slice:":1"|upper }}
        </div>
        <div class="chat-header-info">
            <h5>
                {{ other_user.username }}
                {% if other_user.is_online %}
                    <span class="online-dot" style="display:inline-block;"></span>
                {% endif %}
            </h5>
            {% if other_user.is_online %}
                <p>Active now</p>
            {% else %}
                <p style="color:var(--muted);">Offline</p>
            {% endif %}
        </div>
    </div>

    <!-- Chat messages -->
    <div class="chat-messages" id="chat-box">
        {% for msg in messages %}
            <div class="chat-bubble {% if msg.sender == request.user %}sent{% else %}received{% endif %}"
                data-id="{{ msg.id }}">
                <div class="bubble-content">{{ msg.content }}</div>
                <div class="bubble-meta">
                    <span>{{ msg.timestamp|date:"H:i" }}</span>
                    {% if msg.sender == request.user %}
                        <span class="read-receipt">
                            {% if msg.is_read %}✓✓{% else %}✓{% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Typing indicator -->
    <div id="typing-indicator" class="chat-bubble received typing-bubble" style="display:none;">
        <div class="bubble-content typing-animation">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <!-- Input -->
    <div class="chat-input-bar">
        <input type="text" id="message-input" placeholder="Type a message…" autocomplete="off">
        <button class="btn-send">Send ↑</button>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const roomName = "{{ room_name }}";
    const receiverId = "{{ other_user.id }}";
    const currentUserId = "{{ request.user.id }}";

    const chatBox = document.getElementById("chat-box");
    const typingIndicator = document.getElementById("typing-indicator");
    const input = document.getElementById("message-input");
    const sendBtn = document.querySelector(".btn-send");

    let typingTimeout;
    let isSocketOpen = false;

    // Use secure WebSocket if page is HTTPS
    const socket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") +
        window.location.host +
        "/ws/chat/" + roomName + "/"
    );

    // Wait until connection is open
    socket.onopen = function() {
        isSocketOpen = true;

        // Send read receipts for existing unread messages
        let unreadMessageIds = [];
        document.querySelectorAll(".chat-bubble.received").forEach(function(bubble) {
            const messageId = bubble.getAttribute("data-id");
            if (messageId) unreadMessageIds.push(messageId);
        });

        if (unreadMessageIds.length > 0) {
            socket.send(JSON.stringify({
                type: "read",
                message_ids: unreadMessageIds
            }));
        }
    };

    // Handle incoming WebSocket messages
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === "typing" && data.user !== "{{ request.user.username }}") {
            typingIndicator.style.display = "block";
            chatBox.appendChild(typingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        if (data.type === "stop_typing") {
            typingIndicator.style.display = "none";
        }

        if (data.type === "message") {
            typingIndicator.style.display = "none";

            const div = document.createElement("div");
            div.setAttribute("data-id", data.message_id);

            if (data.sender_id == currentUserId) {
                div.className = "chat-bubble sent";
                div.innerHTML = `
                    <div class="bubble-content">${data.message}</div>
                    <div class="bubble-meta">
                        <span>Just now</span>
                        <span class="read-receipt">✓</span>
                    </div>
                `;
            } else {
                div.className = "chat-bubble received";
                div.innerHTML = `
                    <div class="bubble-content">${data.message}</div>
                    <div class="bubble-meta">
                        <span>Just now</span>
                    </div>
                `;
            }

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        if (data.type === "read_receipt") {
            data.message_ids.forEach(function(id) {
                const bubble = document.querySelector(`.chat-bubble.sent[data-id='${id}']`);
                if (bubble) {
                    const receipt = bubble.querySelector(".read-receipt");
                    if (receipt) receipt.innerText = "✓✓";
                }
            });
        }
    };

    // Send a message function globally
    window.sendMessage = function() {
        const message = input.value.trim();
        if (!message || !isSocketOpen) return;

        socket.send(JSON.stringify({
            type: "message",
            message: message,
            receiver_id: receiverId
        }));

        input.value = "";
        socket.send(JSON.stringify({ type: "stop_typing" }));
    };

    // Typing indicator
    input.addEventListener("input", function() {
        if (!isSocketOpen) return;

        socket.send(JSON.stringify({ type: "typing" }));

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.send(JSON.stringify({ type: "stop_typing" }));
        }, 1000);
    });

    // Send message on Enter key
    input.addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendMessage();
    });

    // Send message on button click
    sendBtn.addEventListener("click", sendMessage);

    // Scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;

});
</script>

{% endblock %}
