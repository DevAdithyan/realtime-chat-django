{% extends 'base.html' %}
{% block content %}

<h4 class="users-header">Messages</h4>

<div class="users-card">
    {% for item in users_with_unread %}
        <a href="{% url 'chat' item.user.id %}" 
            class="user-item"
            data-user-id="{{ item.user.id }}">
            <div class="user-info">
                <div class="user-avatar">
                    {{ item.user.username|slice:":1"|upper }}
                </div>
                <span class="user-name">
                    {{ item.user.username }}
                </span>

                {% if item.unread_count > 0 %}
                    <span class="unread-badge">
                        {{ item.unread_count }}
                    </span>
                {% endif %}
            </div>

            {% if item.user.is_online %}
                <div class="online-badge">
                    <div class="online-dot"></div>
                    Active now
                </div>
            {% else %}
                <span class="last-seen">
                    {{ item.user.last_seen|date:"M d, H:i" }}
                </span>
            {% endif %}
        </a>
    {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // Use WSS if page is HTTPS
    const userSocket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") +
        window.location.host +
        '/ws/chat/{{ request.user.id }}/'
    );

    // Track socket open state
    let isSocketOpen = false;
    userSocket.onopen = function() {
        isSocketOpen = true;
    };

    userSocket.onmessage = function(e) {
        if (!isSocketOpen) return;

        const data = JSON.parse(e.data);

        if (data.type === "unread_update") {
            const userItem = document.querySelector(
                `.user-item[data-user-id='${data.sender_id}']`
            );

            if (userItem) {
                let badge = userItem.querySelector(".unread-badge");

                if (!badge) {
                    // Create new badge
                    badge = document.createElement("span");
                    badge.classList.add("unread-badge");
                    badge.innerText = 1;
                    userItem.appendChild(badge);
                } else {
                    // Increment existing badge
                    badge.innerText = parseInt(badge.innerText) + 1;
                }
            }
        }
    };

    // Optional: reset badge on click (when opening chat)
    document.querySelectorAll(".user-item").forEach(function(item) {
        item.addEventListener("click", function() {
            const badge = item.querySelector(".unread-badge");
            if (badge) badge.remove();
        });
    });

});
</script>

{% endblock %}
